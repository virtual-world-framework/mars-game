# Copyright 2014 Lockheed Martin Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may 
# not use this file except in compliance with the License. You may obtain 
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and 
# limitations under the License.

---
extends: ../scenario/scenario.vwf
properties:
  scenarioName: Mission3Task3

  scenePath: /
  nextScenarioPath: "Mission3Task4"

  startState:
  # objective
  - setObjective:
    - "Edit your navigate procedure: Only turn North if you need to."

  # sounds/video
  - playSound:
    - musicStandardGameplay
  - playSound:
    - environmentWind
  - setProperty:
    - videoManager  
    - url 
    - [ "assets/video/successCutscene02_newAudio.mp4" ]

  #blockly
  - enableBlocklyNodes:
    - rover
  - setProperty:
    - rover
    - blockly_xml
    - <xml><block type="procedures_defnoreturn" deletable="false" editable="false" id="21" x="-20" y="-340"><mutation><arg name="y-coordinate"></arg></mutation><field name="NAME">navigate</field><statement name="STACK"><block type="controls_whileUntil" id="35" deletable="false" editable="false" inline="false"><value name="BOOL"><block type="controls_sensor_heading" deletable="false" movable="false" editable="false" id="62" inline="false"><value name="INPUT"><block type="logic_cond_out" deletable="false" movable="false" editable="false" id="68" inline="false"><field name="VALUE">!==</field><value name="INPUT"><block type="math_number_angle_select" id="77" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn" deletable="false" movable="false" editable="false" id="96"></block></statement><next><block type="controls_whileUntil" deletable="false" movable="false" editable="false" id="43" inline="false"><value name="BOOL"><block type="variables_get" deletable="false" movable="false" editable="false" id="102" inline="false"><field name="VAR">y-coordinate</field><value name="INPUT"><block type="logic_cond_out" deletable="false" movable="false" editable="false" id="64" inline="false"><field name="VALUE">&lt;</field><value name="INPUT"><block type="controls_sensor_position_y" id="51" inline="false" editable="false"></block></value></block></value></block></value><statement name="DO"><block type="rover_moveForward" deletable="false" movable="false" editable="false" id="114"></block></statement></block></next></block></statement></block><block type="controls_whileUntil" id="31" inline="false" deletable="false" editable="false" x="-20" y="-60"><value name="BOOL"><block type="controls_sensor_heading" id="49" inline="false" deletable="false" movable="false" editable="false"><value name="INPUT"><block type="logic_cond_out" id="54" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">===</field><value name="INPUT"><block type="math_number_angle_select" id="63" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn" deletable="false" movable="false" editable="false" id="85"></block></statement><next><block type="procedures_callnoreturn" id="119" deletable="false" movable="false" editable="false" inline="false"><mutation name="navigate"><arg name="y-coordinate"></arg></mutation><value name="ARG0"><block type="math_number_field" deletable="false" movable="false" editable="false" id="129" inline="false"><field name="VALUE">-3</field></block></value></block></next></block></xml>
  - loadToolbox:
    - rover
    - source/scenario/blockly/mission3.xml
  - resetRoverSensors:

  #Manny
  - addToGrid:
    - rover
    - [ -17, 26 ]
  - selectRover:
    - rover
  - callMethod:
    - rover
    - setHeading
    - 180
  - setProperty:
    - rover
    - battery
    - 40
  - setProperty:
    - rover
    - batteryMax
    - 40
  - setProperty:
    - rover
    - blockly_allowedBlocks
    - 70

  # Perry, Rosie disabled
  - setProperty:
    - rover2
    - visible
    - false
  - setProperty:
    - rover3
    - visible
    - false
  - setProperty:
    - minirover
    - visible
    - false

  # Disable Blockly line
  - setProperty:
    - blocklyLine
    - visible
    - false
  - setProperty:
    - blocklyLine
    - opacity
    - 0

  # Graph

  - addToGrid:
    - blocklyGraph
    - [ -17, 32 ]
  - setGridAxes:
    - 32
    - -17

children:
  triggerManager:
    extends: ../triggers/triggerManager.vwf
    properties: 
      triggers$:
        playStartingVO_3d:
          triggerCondition:
          - and:
            - doOnce:
            - onScenarioStart:
          actions:
          - playSound:
            - TM3VO7_Rover
          - playSound:
            - TM3VO8_MC

        openMissionBrief_3_3:
          triggerCondition:
          - and:
            - onScenarioStart:
            - doOnce:
          actions:
          - delay:
            - 24
            - openMissionBrief:

        succeedOnSuccessfulMovement_3_3:
          group: successOrFailure
          priority: 0
          triggerCondition:
          - and:
            - onBlocklyStopped:
              - rover
            - hasHeading:
              - rover
              - 270
            - isAtPosition:
              - rover
              - [-17, 26]

          actions:
          - clearBlockly:
          - scenarioSuccess:
          - showAlert:
            - "Test program completed!"
          - playSound:
            - musicSuccessShort

  brief:
    extends: ../missionBrief.vwf
    properties:
      title: "Mission 3, Task 3"
      content: >
        Good job on editing the procedure navigation!
        <br><br>You should only need to turn if you're going to move. You'll need
        to further edit your navigate procedure to reflect this.
        <br><br>This will require the use of an "If" block, which can be found in
        the "Conditionals" tab. The "do" section of the "If" block should
        contain the rest of the actions currently in your procedure definition. The "If"
        section should be a check of whether your current y-position is greater than that 
        of your destination's. Your code should only execute if this is true.
        <br><br>In order to use the value of your destination's y-position in the procedure
        definition you'll need to right click the procedure definition, and chooose "Create get [variable name]".
        You'll spawn a block representing the y-position of your destination location.