# Copyright 2014 Lockheed Martin Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may 
# not use this file except in compliance with the License. You may obtain 
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and 
# limitations under the License.

---
extends: ../scenario/scenario.vwf
properties:
  scenarioName: Mission4Task4
  nextScenarioPath: Mission4Task5

  startState:

  # objective
  - setObjective:
    - "Reflect your triangle across the Y axis."

  # Blockly
  - setProperty:
    - rover2
    - blockly_xml
    - <xml><block type="draw_triangle" id="10" deletable="false" inline="false" x="60" y="140"><value name="pointA"><block type="ordered_pair_config" id="16" movable="false" inline="true"><value name="XFIELD"><block type="math_number_frozen" id="34" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">0</field></block></value><value name="YFIELD"><block type="math_number_frozen" id="43" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">0</field></block></value></block></value><value name="pointB"><block type="ordered_pair_config" id="22" movable="false" inline="true"><value name="XFIELD"><block type="math_number_frozen" id="44" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">0</field></block></value><value name="YFIELD"><block type="math_number_frozen" id="42" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">6</field></block></value></block></value><value name="pointC"><block type="ordered_pair_config" id="28" movable="false" inline="true"><value name="XFIELD"><block type="math_number_frozen" id="40" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">-6</field></block></value><value name="YFIELD"><block type="math_number_frozen" id="41" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">0</field></block></value></block></value></block></xml>
  - enableBlocklyNodes:
    - rover
    - rover2
  - loadToolbox:
    - rover
    - source/scenario/blockly/mission4.xml
  - loadToolbox:
    - rover2
    - source/scenario/blockly/mission4_perry.xml

  # sounds/music
  - playSound:
    - musicMission4Loop
  - playSound:
    - environmentWind

  # Manny
  - addToGrid:
    - rover
    - [ -27, 31 ]
  - callMethod:
    - rover
    - setHeading
    - 0
  - setProperty:
    - rover
    - battery
    - 12
  - setProperty:
    - rover
    - batteryMax
    - 150
  - setProperty:
    - rover
    - blockly_allowedBlocks
    - 15
  - setProperty:
    - rover
    - lowRam
    - 3

  # Perry
  - setProperty:
    - rover2
    - visible
    - true
  # TODO: handle adding him if we jump to this task from elsewhere  
  # - addToGrid:
  #   - rover2
  #   - [ -10, -10 ]
  - setProperty:
    - rover2
    - battery
    - 1000
  - setProperty:
    - rover2
    - batteryMax
    - 1000
  - setProperty:
    - rover2
    - blockly_allowedBlocks
    - 16
  - setProperty:
    - rover2
    - lowRam
    - 5
  - selectRover:
    - rover2

  # Rosie disabled
  - setProperty:
    - rover3
    - visible
    - false

  # Grid and disable blocklyLine
  - setGridAxes:
    - 16
    - -22

  - setProperty:
    - blocklyLine
    - visible
    - false

  - setProperty:
    - blocklyLine
    - opacity
    - 0


  # Solar panel construction
  
  - drawTriangle:
    - [ 0, 0 ]
    - [ 0, 6 ]
    - [ 6, 0 ]

  - addToGrid:
    - solarPanel1
    - [ -27, 19 ]

  - addToGrid:
    - solarPanel2
    - [ -21, 19 ]

  - setProperty:
    - solarPanel1
    - scale
    - [1.2, 1.2, 1.2]
  - setProperty:
    - solarPanel1
    - rotation
    - [0 ,0 ,1 , 90 ]
  - setProperty:
    - solarPanel1
    - visible
    - true
  - setProperty:
    - solarPanel1
    - built
    - false

  - setProperty:
    - solarPanel2
    - scale
    - [1.2, 1.2, 1.2]
  - setProperty:
    - solarPanel2
    - visible
    - false

  - setProperty:
    - solarPanel3
    - visible
    - false

  - setProperty:
    - solarPanel4
    - visible
    - false
  
children:
  triggerManager:
    extends: ../triggers/triggerManager.vwf
    properties: 
      triggers$:

        openMissionBrief_4_4:
          triggerCondition:
          - and:
            - onScenarioStart:
            - doOnce:
          actions:
          - delay:
            - 9
            - openMissionBrief:

        setStartPosition_4_4:
          triggerCondition:
          - and:
            - onScenarioStart:
            - not:
              - isAtPosition:
                - rover2
                - [ -24, 16 ]
            - not:
              - isAtPosition:
                - rover2
                - [ -24, 22 ]
            - not:
              - isAtPosition:
                - rover2
                - [ -27, 16 ]
          actions:
            - addToGrid:
              - rover2
              - [ -24, 16 ]

        succeedOnTriangle_4_4:
          group: successOrFailure
          priority: 0
          triggerCondition:
          - onBlocklyPolygon:
            - rover2
            - [ [ 0, 0 ], [ 0, 6 ], [ 6, 0 ] ]
          actions:
          - writeToBlackboard:
            - disableFailOnIncompleteProgram
          - buildBaseComponent:
            - solarPanel2
          - deleteNanites:
            - nanites_Mission4Task4
          - delay:
            - 6
            - showAlert:
              - "I created the correct triangle!"
            - callMethod:
              - rover2
              - stopExecution
            - scenarioSuccess:
            - playSound:
              - musicSuccessShort
            - playSound:
              - PerryIDidIt

        scenarioEnded4_4:
          triggerCondition:
          - or: 
            - onScenarioSucceeded:
            - onScenarioFailed:
          actions:
          - setProperty:
            - rover2
            - surveyArray
            - []
          - deleteNanites:
            - nanites_Mission4Task4

  brief:
    extends: ../missionBrief.vwf
    properties:
      title: "Mission 4, Task 4"
      content: >
        Excellent! That triangle is perfect for a solar panel! 
        Let's add some more so we can generate more power. For the next triangle, 
        we can reflect the last triangle so we don't have to make new vertices from 
        scratch! <br><br>To reflect, or flip the triangle across the y axis, you multiply 
        the x values of the vertices by -1. You can do the same across 
        the x axis by multiplying the y values by -1. Try multiplying the x values 
        to reflect the triangle across the y axis.
