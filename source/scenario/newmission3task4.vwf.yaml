# Copyright 2014 Lockheed Martin Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may 
# not use this file except in compliance with the License. You may obtain 
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and 
# limitations under the License.

---
extends: ../scenario/scenario.vwf
properties:
  scenarioName: Mission3Task4

  scenePath: /
  nextScenarioPath: "Mission3Task5"

  startState:
  # objective
  - setObjective:
    - "Edit the navigate procedure: Duplicate the if block and change the values to move up to [0,-3]."

  # sounds/video
  - playSound:
    - musicStandardGameplay
  - playSound:
    - environmentWind
  - setProperty:
    - videoManager  
    - url 
    - [ "assets/video/successCutscene02_newAudio.mp4" ]

  #blockly
  - enableBlocklyNodes:
    - rover
  - setProperty:
    - rover
    - blockly_xml
    - <xml><block type="procedures_defnoreturn" deletable="false" editable="false" x="-20" y="-340"><mutation><arg name="y-coordinate"></arg></mutation><field name="NAME">navigate</field><statement name="STACK"><block type="controls_if_nomut" inline="false"><value name="IF0"><block type="variables_get" deletable="false" movable="false" inline="false"><field name="VAR">y-coordinate</field><value name="INPUT"><block type="logic_cond_out" deletable="false" movable="false" inline="false"><field name="VALUE">&lt;</field><value name="INPUT"><block type="controls_sensor_position_y" inline="false" deletable="false" movable="false" editable="false"></block></value></block></value></block></value><statement name="DO0"><block type="controls_whileUntil" deletable="false" movable="false" inline="false"><value name="BOOL"><block type="controls_sensor_heading" inline="false" deletable="false" movable="false" editable="false"><value name="INPUT"><block type="logic_cond_out" inline="false" deletable="false" movable="false"><field name="VALUE">!==</field><value name="INPUT"><block type="math_number_angle_select" deletable="false" movable="false" inline="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn" deletable="false" movable="false"></block></statement><next><block type="controls_whileUntil" inline="false" deletable="false" movable="false"><value name="BOOL"><block type="variables_get" inline="false" deletable="false" movable="false"><field name="VAR">y-coordinate</field><value name="INPUT"><block type="logic_cond_out" inline="false" deletable="false" movable="false"><field name="VALUE">&lt;</field><value name="INPUT"><block type="controls_sensor_position_y" inline="false" deletable="false" movable="false"></block></value></block></value></block></value><statement name="DO"><block type="rover_moveForward" deletable="false" movable="false" ></block></statement></block></next></block></statement></block></statement></block><block type="controls_whileUntil" deletable="false" editable="false" inline="false" x="-20" y="-500"><value name="BOOL"><block type="controls_sensor_heading"  inline="false" deletable="false" movable="false" editable="false"><value name="INPUT"><block type="logic_cond_out"  deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">===</field><value name="INPUT"><block type="math_number_angle_select" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn" deletable="false" movable="false" editable="false"></block></statement><next><block type="procedures_callnoreturn" deletable="false" movable="false" editable="false"  inline="false"><mutation name="navigate"><arg name="y-coordinate"></arg></mutation><value name="ARG0"><block type="math_number_field" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">-3</field></block></value></block></next></block></xml>
  - loadToolbox:
    - rover
    - source/scenario/blockly/mission3b.xml
  - delay:
    - .5  
    - callMethod:
      - rover
      - resetSensors

  #Manny
  - addToGrid:
    - rover
    - [-17, 26]
  - selectRover:
    - rover
  - callMethod:
    - rover
    - setHeading
    - 270
  - setProperty:
    - rover
    - battery
    - 40
  - setProperty:
    - rover
    - batteryMax
    - 40
  - setProperty:
    - rover
    - blockly_allowedBlocks
    - 70

  # Perry, Rosie disabled
  - setProperty:
    - rover2
    - visible
    - false
  - setProperty:
    - rover3
    - visible
    - false
  - setProperty:
    - minirover
    - visible
    - false

  # Disable Blockly line
  - setProperty:
    - blocklyLine
    - visible
    - false
  - setProperty:
    - blocklyLine
    - opacity
    - 0

  # Graph

  - addToGrid:
    - blocklyGraph
    - [ -17, 32 ]
  - setGridAxes:
    - 32
    - -17
  - setProperty:
    - cargoPod2
    - rotation
    - [0 ,0 ,1 , -45 ]

children:
  triggerManager:
    extends: ../triggers/triggerManager.vwf
    properties: 
      triggers$:
        playStartingVO_3d:
          triggerCondition:
          - and:
            - doOnce:
            - onScenarioStart:
          actions:
          - playSound:
            - TM3VO9_Rover
          - playSound:
            - TM3V10_MC
          - setProperty:
            - hud
            - enabled
            - false

        openMissionBrief_3_4:
          triggerCondition:
          - and:
            - onScenarioStart:
            - doOnce:
          actions:
          - delay:
            - 19
            - openMissionBrief:
            - setProperty:
              - hud
              - enabled
              - true

        highlightEndTile:
          triggerCondition:
          - onScenarioStart:
          actions:
          - callOutObjective:
            - [ -17, 29 ]
 
        succeedOnSuccessfulMovement_3_4:
          group: successOrFailure
          priority: 0
          triggerCondition:
          - and:
            - onBlocklyStopped:
              - rover
            - isAtPosition:
              - rover
              - [ -17, 29 ]
          actions:
          - clearBlockly:
          - scenarioSuccess:
          - showAlert:
            - "Test program completed!"
          - playSound:
            - musicSuccessShort

  brief:
    extends: ../missionBrief.vwf
    properties:
      title: "Mission 3, Task 4"
      content: >
        You're getting closer to recreating the whole procedure!
        <br><br>Currently you can only move South, you'll want to add functionality 
        that lets you navigate to other directions as well. We'll begin by navigating
        North.
        <br><br>The code for navigating North should be very similar to the code
        you currently use to navigate South. You can duplicate this code by right-clicking
        the "if" block, attaching this new block to the end of the old "if" block, and making
        some changes that will allow it to move North instead of South. Perhaps you'll want to pay 
        attention to the comparison between your current y-position and your destination's y-position.
        Which one should be larger if you're planning on moving North? Also, you'll need to change the 
        direction that you're comparing your current direction of travel to.